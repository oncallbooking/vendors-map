<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Final Dashboard — 10 Charts, Sidebar Filters, Fullscreen</title>

  <!-- Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --text:#0f172a; --muted:#6b7280; --accent:#2563eb; --radius:12px; --shadow:0 6px 20px rgba(16,24,40,0.06);
    }
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);margin:0}
    .app{display:flex;min-height:100vh}
    aside.sidebar{width:320px;background:#071028;color:#fff;padding:18px;box-shadow:4px 0 20px rgba(2,6,23,0.06);overflow:auto}
    main{flex:1;padding:20px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .filters-sidebar { background:var(--card); padding:12px; border-radius:10px; box-shadow:var(--shadow); color:var(--text); margin-bottom:14px; }
    .filter-group { max-height:220px; overflow:auto; padding:8px; border-radius:8px; border:1px solid #efefef; background:#fafafa; margin-bottom:10px }
    .filter-title { font-weight:600; font-size:0.95rem; margin-bottom:6px; display:flex;align-items:center;justify-content:space-between; }
    .viz-row{display:flex;gap:16px;align-items:flex-start}
    .col-chart, .col-map{flex:1;background:var(--card);padding:12px;border-radius:10px;box-shadow:var(--shadow);min-width:320px}
    #map{height:520px;border-radius:8px}
    canvas#mainChart{width:100% !important; height:520px !important}
    .table-section{margin-top:18px;background:var(--card);padding:12px;border-radius:10px;box-shadow:var(--shadow)}
    .table-wrapper{max-height:360px; overflow:auto}
    table { width:100%; border-collapse:collapse }
    table td, table th{ padding:10px; vertical-align:top; white-space:normal; word-break:break-word }
    table thead th{ position:sticky; top:0; background:var(--card); z-index:2; }
    .control-small{height:40px;padding:.375rem .6rem}
    .select-all { font-size:0.85rem; cursor:pointer; color:var(--accent); }
    @media(max-width:1100px){ aside.sidebar{display:none} .viz-row{flex-direction:column} }
    /* Fullscreen overrides */
    :fullscreen .col-chart, :fullscreen .col-map { height: 100vh; width:100vw; margin:0; border-radius:0; box-shadow:none; }
    /* theme dark */
    .theme-dark{background:#071028;color:#e6eef8}
    .theme-dark .col-chart, .theme-dark .col-map, .theme-dark .table-section, .theme-dark .filters-sidebar{ background:#0b1726 }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar (filters moved here) -->
    <aside class="sidebar">
      <div class="d-flex gap-2 align-items-center mb-3">
        <div style="width:46px;height:46px;border-radius:8px;background:#fff;color:#071028;display:flex;align-items:center;justify-content:center">
          <i class="fas fa-chart-pie"></i>
        </div>
        <div>
          <h5 style="margin:0">Analytics Pro</h5>
          <small style="opacity:.85">10 charts · Fullscreen · Exports</small>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label text-white-50 mb-1">Upload dataset</label>
        <input id="filePicker" type="file" accept=".xlsx,.xls,.csv" class="form-control form-control-sm">
        <div class="mt-2 d-grid">
          <button id="loadDemo" class="btn btn-sm btn-outline-light">Load Demo</button>
        </div>
      </div>

      <div class="filters-sidebar">
        <div class="d-flex justify-content-between align-items-end mb-2">
          <div><strong>Filters</strong><div class="text-muted small">Select to filter results</div></div>
          <div class="text-end">
            <button id="resetFiltersBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
          </div>
        </div>

        <!-- Dynamic generated filter groups -->
        <div id="filtersContainer" style="max-height:58vh; overflow:auto"></div>

        <div class="mt-2 d-flex gap-2 justify-content-between">
          <div><small class="text-muted">Rows: <span id="rowCount">0</span></small></div>
          <div><small class="text-muted">Cols: <span id="colCount">0</span></small></div>
        </div>
      </div>

      <div class="mt-3">
        <button id="themeToggle" class="btn btn-sm btn-light w-100 mb-2"><i class="fas fa-moon me-1"></i> Theme</button>
        <button id="exportCsv" class="btn btn-sm btn-outline-light w-100 mb-2" disabled><i class="fas fa-file-csv me-1"></i> Export CSV</button>
        <button id="exportXlsx" class="btn btn-sm btn-outline-light w-100 mb-2" disabled><i class="fas fa-file-excel me-1"></i> Export XLSX</button>
      </div>
    </aside>

    <!-- Main content -->
    <main>
      <div class="header">
        <div>
          <h3 style="margin:0">Dashboard</h3>
          <small class="text-muted">Sidebar filters · full-screen charts & map · export & print</small>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <input id="globalSearch" class="form-control form-control-sm" placeholder="Global search..." style="min-width:240px">
          <select id="chartSelect" class="form-select control-small" style="min-width:220px">
            <!-- 10 chart types -->
            <option value="bar">Bar</option>
            <option value="horizontalBar">Horizontal Bar</option>
            <option value="line">Line</option>
            <option value="area">Area</option>
            <option value="pie">Pie</option>
            <option value="doughnut">Doughnut</option>
            <option value="polarArea">Polar Area</option>
            <option value="radar">Radar</option>
            <option value="bubble">Bubble</option>
            <option value="scatter">Scatter</option>
          </select>
          <input id="topN" type="number" min="1" value="10" class="form-control control-small" style="width:100px" title="Top N">
          <div class="btn-group">
            <button id="chartFullscreen" class="btn btn-outline-secondary btn-sm" title="Chart fullscreen"><i class="fas fa-expand"></i></button>
            <button id="mapFullscreen" class="btn btn-outline-secondary btn-sm" title="Map fullscreen"><i class="fas fa-expand"></i></button>
            <button id="downloadChart" class="btn btn-outline-primary btn-sm" title="Download Chart" disabled><i class="fas fa-download"></i></button>
            <button id="printBtn" class="btn btn-outline-secondary btn-sm" title="Print"><i class="fas fa-print"></i></button>
          </div>
        </div>
      </div>

      <div class="viz-row">
        <div class="col-chart">
          <h5 id="chartTitle">Main Chart</h5>
          <canvas id="mainChart"></canvas>
        </div>

        <div class="col-map">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0"><i class="fas fa-map-marker-alt me-1"></i> Map</h5>
            <small id="mapStatus" class="text-muted">Idle</small>
          </div>
          <div id="map"></div>
        </div>
      </div>

      <div class="table-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0"><i class="fas fa-table me-1"></i> Data Table</h6>
          <div class="d-flex gap-2">
            <input id="tableSearch" class="form-control form-control-sm" placeholder="Search table..." style="min-width:220px">
            <select id="rowsPerPage" class="form-select form-select-sm" style="width:120px">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>

        <div class="table-wrapper">
          <table class="table table-hover mb-0">
            <thead>
              <tr id="tableHeader"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  // ---------- State ----------
  let rawData = [];     // original rows (array of objects)
  let viewData = [];    // filtered rows
  let meta = { headers:[], numeric:[], categorical:[] };
  let chart = null;
  let map = null, markerLayer = null;

  // DOM
  const filePicker = document.getElementById('filePicker');
  const loadDemo = document.getElementById('loadDemo');
  const filtersContainer = document.getElementById('filtersContainer');
  const chartSelect = document.getElementById('chartSelect');
  const topN = document.getElementById('topN');
  const downloadChart = document.getElementById('downloadChart');
  const globalSearch = document.getElementById('globalSearch');
  const tableSearch = document.getElementById('tableSearch');
  const tableBody = document.getElementById('tableBody');
  const tableHeader = document.getElementById('tableHeader');
  const rowsPerPage = document.getElementById('rowsPerPage');
  const exportCsv = document.getElementById('exportCsv');
  const exportXlsx = document.getElementById('exportXlsx');
  const mapStatus = document.getElementById('mapStatus');
  const themeToggle = document.getElementById('themeToggle');
  const resetFiltersBtn = document.getElementById('resetFiltersBtn');
  const chartFullscreen = document.getElementById('chartFullscreen');
  const mapFullscreen = document.getElementById('mapFullscreen');
  const downloadChartBtn = document.getElementById('downloadChart');

  // ---------- Init ----------
  document.addEventListener('DOMContentLoaded', ()=>{
    initMap();
    attachEvents();
    loadDemoDataset();
  });

  function attachEvents(){
    filePicker.addEventListener('change', handleFileUpload);
    loadDemo.addEventListener('click', loadDemoDataset);
    chartSelect.addEventListener('change', renderChart);
    topN.addEventListener('change', renderChart);
    globalSearch.addEventListener('input', applyFiltersDebounced);
    tableSearch.addEventListener('input', renderTable);
    rowsPerPage.addEventListener('change', renderTable);
    exportCsv.addEventListener('click', exportCSV);
    exportXlsx.addEventListener('click', exportXLSX);
    themeToggle.addEventListener('click', ()=> document.body.classList.toggle('theme-dark'));
    resetFiltersBtn.addEventListener('click', ()=> { resetAllFilters(); applyFilters(); });
    chartFullscreen.addEventListener('click', ()=> toggleFullscreen(document.querySelector('.col-chart')));
    mapFullscreen.addEventListener('click', ()=> { toggleFullscreen(document.querySelector('.col-map')); setTimeout(()=> map.invalidateSize(), 300); });
    downloadChartBtn.addEventListener('click', downloadChartImage);
    document.addEventListener('fullscreenchange', ()=> { setTimeout(()=> { if(map) map.invalidateSize(); if(chart) try{ chart.resize(); }catch(e){} }, 200); });
  }

  // ---------- File upload ----------
  async function handleFileUpload(e){
    const f = e.target.files[0];
    if(!f) return;
    const name = f.name.toLowerCase();
    try {
      if(name.endsWith('.csv')){
        const text = await f.text();
        const parsed = Papa.parse(text, { header:true, dynamicTyping:true, skipEmptyLines:true });
        rawData = parsed.data;
      } else {
        const ab = await f.arrayBuffer();
        const wb = XLSX.read(ab, { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        rawData = XLSX.utils.sheet_to_json(ws, { defval: null });
      }
      postLoad();
    } catch(err){
      alert('Upload failed: ' + err.message);
    }
  }

  function postLoad(){
    if(!rawData || !rawData.length){ alert('No rows found'); return; }
    detectMeta();
    buildFilters();
    resetAllFilters();
    applyFilters();
    exportCsv.disabled = false;
    exportXlsx.disabled = false;
  }

  // ---------- Meta detection ----------
  function detectMeta(){
    const headers = Object.keys(rawData[0] || {});
    meta.headers = headers;
    meta.numeric = []; meta.categorical = [];
    headers.forEach(h=>{
      let cntNum=0, cnt=0;
      for(let i=0;i<Math.min(200,rawData.length);i++){
        const v = rawData[i][h];
        if(v === null || v === undefined || v === '') { cnt++; continue; }
        cnt++;
        if(typeof v === 'number' && isFinite(v)) cntNum++;
        else if(!isNaN(parseFloat(v))) cntNum++;
      }
      if(cnt>0 && (cntNum/cnt) > 0.6) meta.numeric.push(h); else meta.categorical.push(h);
    });
    document.getElementById('rowCount').innerText = rawData.length;
    document.getElementById('colCount').innerText = meta.headers.length;
  }

  // ---------- Filters (sidebar) ----------
  function buildFilters(){
    filtersContainer.innerHTML = '';
    // We'll create groups for first 4 categorical columns (or all if few)
    const groups = meta.categorical.length ? meta.categorical.slice(0,5) : meta.headers.slice(0,3);
    groups.forEach(col=>{
      const wrapper = document.createElement('div');
      wrapper.className = 'filter-group';
      const title = document.createElement('div');
      title.className = 'filter-title';
      title.innerHTML = `<span>${col}</span><span class="select-all" data-col="${col}">Select All</span>`;
      wrapper.appendChild(title);
      // values
      const vals = Array.from(new Set(rawData.map(r => (r[col] ?? '') + '')).values()).filter(x=>x!=='').sort();
      const list = document.createElement('div');
      vals.forEach((v, idx)=>{
        const id = `f_${col}_${idx}`;
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `<input class="form-check-input filter-checkbox" data-col="${col}" type="checkbox" id="${id}" value="${escapeHtml(v)}" checked>
                         <label class="form-check-label" for="${id}">${escapeHtml(v)}</label>`;
        list.appendChild(div);
      });
      wrapper.appendChild(list);
      filtersContainer.appendChild(wrapper);
    });

    // wire select all and instant apply
    filtersContainer.querySelectorAll('.select-all').forEach(sa=>{
      sa.addEventListener('click', (ev)=>{
        const col = sa.dataset.col;
        const cbs = Array.from(document.querySelectorAll(`.filter-checkbox[data-col="${col}"]`));
        const allChecked = cbs.every(cb => cb.checked);
        cbs.forEach(cb => cb.checked = !allChecked);
        applyFilters();
      });
    });

    // instant apply on change
    filtersContainer.querySelectorAll('.filter-checkbox').forEach(cb => cb.addEventListener('change', ()=> applyFilters()));
  }

  function getActiveFilterValuesFor(col){
    return Array.from(document.querySelectorAll(`.filter-checkbox[data-col="${col}"]:checked`)).map(i => i.value);
  }

  function resetAllFilters(){
    const cbs = Array.from(document.querySelectorAll('.filter-checkbox'));
    cbs.forEach(cb => cb.checked = true);
    document.getElementById('globalSearch').value = '';
  }

  // ---------- Apply filters ----------
  let _fdeb;
  function applyFiltersDebounced(){ clearTimeout(_fdeb); _fdeb = setTimeout(()=> applyFilters(), 300); }

  function applyFilters(){
    // construct filter map from visible filter groups
    const groups = Array.from(document.querySelectorAll('.filter-group .filter-title span:first-child')).map(s=>s.textContent);
    let filtered = rawData.slice();

    groups.forEach(col=>{
      const active = getActiveFilterValuesFor(col);
      if(active.length && active.length !== document.querySelectorAll(`.filter-checkbox[data-col="${col}"]`).length){
        filtered = filtered.filter(r => active.includes((r[col] ?? '') + ''));
      }
    });

    // global search
    const q = (globalSearch.value || '').toLowerCase().trim();
    if(q){
      filtered = filtered.filter(r => Object.values(r).some(v => (v===null||v===undefined)?false: (''+v).toLowerCase().includes(q)));
    }

    viewData = filtered;
    renderTable();
    renderChart();
    renderMap();
  }

  // ---------- Chart ----------
  function renderChart(){
    if(!viewData || !viewData.length) {
      if(chart){ chart.destroy(); chart=null; }
      return;
    }
    const chartType = chartSelect.value;
    const top = Math.max(1, Number(topN.value) || 10);
    // pick category and numeric field heuristically
    const cat = meta.categorical[0] || meta.headers[0];
    const num = meta.numeric[0] || meta.headers.find(h => h!==cat) || meta.headers[0];

    // aggregate by category
    const agg = {};
    viewData.forEach(r => {
      const k = (r[cat] ?? 'Unknown') + '';
      const v = Number(r[num]) || 0;
      agg[k] = (agg[k] || 0) + v;
    });
    const entries = Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0, top);
    const labels = entries.map(e=>e[0]);
    const values = entries.map(e=>e[1]);
    const palette = ['#2563eb','#06b6d4','#f97316','#10b981','#7c3aed','#ef4444','#f59e0b','#0ea5a4','#8b5cf6','#e11d48'];
    const colors = labels.map((_,i)=>palette[i%palette.length]);

    const ctx = document.getElementById('mainChart').getContext('2d');
    if(chart){ try{ chart.destroy(); }catch(e){} chart=null; }
    // Chart.js option mapping for the requested types
    let cfgType = 'bar';
    let cfgOptions = { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} , scales:{ y:{beginAtZero:true} } };
    let cfgData = {};

    switch(chartType){
      case 'bar':
        cfgType='bar';
        cfgData = { labels, datasets:[{ label:num, data:values, backgroundColor:colors }]};
        break;
      case 'horizontalBar':
        cfgType='bar';
        cfgOptions.scales = { x:{beginAtZero:true} , y:{beginAtZero:false} };
        cfgOptions.indexAxis = 'y';
        cfgData = { labels, datasets:[{ label:num, data:values, backgroundColor:colors }]};
        break;
      case 'line':
        cfgType='line';
        cfgData = { labels, datasets:[{ label:num, data:values, borderColor:colors[0], backgroundColor:'rgba(0,0,0,0)', fill:false }]};
        break;
      case 'area':
        cfgType='line';
        cfgData = { labels, datasets:[{ label:num, data:values, borderColor:colors[0], backgroundColor:colors[0], fill:true }]};
        break;
      case 'pie':
        cfgType='pie';
        cfgData = { labels, datasets:[{ data:values, backgroundColor:colors }]};
        cfgOptions.plugins.legend.display = true;
        break;
      case 'doughnut':
        cfgType='doughnut';
        cfgData = { labels, datasets:[{ data:values, backgroundColor:colors }]};
        cfgOptions.plugins.legend.display = true;
        break;
      case 'polarArea':
        cfgType='polarArea';
        cfgData = { labels, datasets:[{ data:values, backgroundColor:colors }]};
        cfgOptions.plugins.legend.display = true;
        break;
      case 'radar':
        cfgType='radar';
        cfgData = { labels, datasets:[{ label:num, data:values, backgroundColor:colors[0], borderColor:colors[0], fill:true }]};
        cfgOptions.plugins.legend.display = false;
        break;
      case 'bubble':
        // create bubble points: use values as r, and spread them across x
        cfgType='bubble';
        cfgData = { datasets: labels.map((l,i)=>({ label:l, data:[{ x:i+1, y:values[i], r: Math.max(4, Math.sqrt(values[i]) / 20 ) }], backgroundColor:colors[i] })) };
        cfgOptions.plugins.legend.display = false;
        break;
      case 'scatter':
        cfgType='scatter';
        cfgData = { datasets:[{ label:num, data: labels.map((l,i)=> ({ x:i+1, y: values[i] })), backgroundColor:colors[0] }]};
        cfgOptions.plugins.legend.display = false;
        cfgOptions.scales = { x:{ type:'linear', position:'bottom' }, y:{ beginAtZero:true } };
        break;
    }

    chart = new Chart(ctx, { type:cfgType, data:cfgData, options:cfgOptions });
    downloadChart.disabled = false;
  }

  // ---------- Map ----------
  function initMap(){
    map = L.map('map',{ preferCanvas:true }).setView([22.0,79.0],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' }).addTo(map);
    markerLayer = L.layerGroup().addTo(map);
  }

  function renderMap(){
    markerLayer.clearLayers();
    if(!viewData || !viewData.length){ mapStatus.textContent='No pins'; return; }
    // prefer lat/lng columns
    const latKey = meta.headers.find(h=>/lat|latitude/i.test(h));
    const lngKey = meta.headers.find(h=>/lon|lng|longitude/i.test(h));
    if(latKey && lngKey){
      viewData.forEach(r=>{
        const lat = parseFloat(r[latKey]), lng = parseFloat(r[lngKey]);
        if(isFinite(lat) && isFinite(lng)){
          addMarker(lat, lng, r);
        }
      });
      mapStatus.textContent = markerLayer.getLayers().length ? `${markerLayer.getLayers().length} pins` : 'No pins';
      fitMap();
      return;
    }
    // fallback: geocode a place field (limited)
    const placeKey = meta.headers.find(h=>/city|town|village|state|district|place|location/i.test(h));
    if(!placeKey){ mapStatus.textContent='No location fields'; return; }
    mapStatus.textContent = 'Geocoding...';
    // throttle geocoding and limit to 40 unique
    const unique = Array.from(new Set(viewData.map(r=> (r[placeKey] ?? '')+ '').filter(Boolean))).slice(0,40);
    unique.length ? geocodeAndPlot(unique, placeKey) : mapStatus.textContent='No place values';
  }

  async function geocodeAndPlot(unique, placeKey){
    const geos = {};
    for(let i=0;i<unique.length;i++){
      const q = unique[i];
      try{
        await delay(650); // be polite to nominatim
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q + ' India')}`, { headers:{ 'Accept-Language':'en' }});
        if(!resp.ok) continue;
        const arr = await resp.json();
        if(arr && arr[0]) geos[q] = { lat: parseFloat(arr[0].lat), lon: parseFloat(arr[0].lon) };
      }catch(e){ console.warn('geocode failed', e); }
    }
    viewData.forEach(r=>{
      const place = (r[placeKey] ?? '') + '';
      const g = geos[place];
      if(g) addMarker(g.lat, g.lon, r);
    });
    mapStatus.textContent = markerLayer.getLayers().length ? `${markerLayer.getLayers().length} pins` : 'No pins';
    fitMap();
  }

  function addMarker(lat, lng, row){
    const html = Object.entries(row).map(([k,v])=>`<div style="font-size:.9rem"><strong>${escapeHtml(k)}:</strong> ${escapeHtml(v)}</div>`).join('');
    const m = L.marker([lat, lng]);
    m.bindTooltip(`${escapeHtml(row[meta.headers[0]] || '')}`, { direction:'top' });
    m.on('click', ()=> L.popup({ maxWidth:360 }).setLatLng([lat,lng]).setContent(html).openOn(map));
    markerLayer.addLayer(m);
  }
  function fitMap(){ if(!markerLayer || !markerLayer.getLayers().length) return; const group = L.featureGroup(markerLayer.getLayers()); map.fitBounds(group.getBounds().pad(0.15)); }

  function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

  // ---------- Table ----------
  function renderTable(){
    // header from meta.headers
    tableHeader.innerHTML = '';
    const headers = meta.headers.length ? meta.headers : Object.keys(viewData[0] || {});
    headers.forEach(h => {
      const th = document.createElement('th'); th.textContent = h; tableHeader.appendChild(th);
    });
    // rows with pagination (client-side)
    const pageSize = Number(rowsPerPage.value) || 25;
    const q = (tableSearch.value || '').toLowerCase().trim();
    const filtered = (viewData || []).filter(r => {
      if(!q) return true;
      return Object.values(r).some(v => (v===null||v===undefined)?false: (''+v).toLowerCase().includes(q));
    });
    tableBody.innerHTML = '';
    if(!filtered.length){ tableBody.innerHTML = '<tr><td colspan="' + Math.max(1,headers.length) + '" class="text-center text-muted py-3">No records</td></tr>'; return; }
    filtered.slice(0, pageSize).forEach(r => {
      const tr = document.createElement('tr');
      headers.forEach(h => {
        const td = document.createElement('td');
        td.innerHTML = escapeHtml(r[h] ?? '');
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);
    });
  }

  // ---------- Utilities ----------
  function escapeHtml(s){ if(s===null||s===undefined) return ''; return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // ---------- Exports ----------
  function exportCSV(){
    if(!viewData.length) return alert('No data');
    const hdr = meta.headers;
    const lines = [hdr.join(',')].concat(viewData.map(r => hdr.map(h=> `"${String(r[h] ?? '').replace(/"/g,'""')}"`).join(',')));
    const blob = new Blob([lines.join('\n')], { type:'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'export.csv'; a.click();
  }

  function exportXLSX(){
    if(!viewData.length) return alert('No data');
    const ws = XLSX.utils.json_to_sheet(viewData);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Export'); XLSX.writeFile(wb, 'export.xlsx');
  }

  // ---------- Fullscreen & Chart download ----------
  function toggleFullscreen(el){
    if(!document.fullscreenElement){
      el.requestFullscreen && el.requestFullscreen();
    } else {
      document.exitFullscreen && document.exitFullscreen();
    }
  }
  function downloadChartImage(){
    if(!chart) return;
    const a = document.createElement('a');
    a.href = chart.toBase64Image();
    a.download = 'chart.png';
    a.click();
  }

  // ---------- Demo dataset (initial) ----------
  function loadDemoDataset(){
    rawData = [
      { Vendor:'Asha Mart', Type:'Retail', Region:'North', Revenue:120000, Latitude:28.6139, Longitude:77.2090, Portfolio:'Retail chain with 5 outlets' },
      { Vendor:'Kala Wholesalers', Type:'Wholesale', Region:'West', Revenue:300000, Latitude:19.0760, Longitude:72.8777, Portfolio:'Bulk garment supplier' },
      { Vendor:'Suryan Services', Type:'Services', Region:'South', Revenue:90000, Latitude:13.0827, Longitude:80.2707, Portfolio:'Logistics & consulting' },
      { Vendor:'Greenfield Trade', Type:'Wholesale', Region:'North', Revenue:210000, Latitude:28.4595, Longitude:77.0266, Portfolio:'Agriculture wholesale' },
      { Vendor:'Bengal Retail', Type:'Retail', Region:'East', Revenue:150000, Latitude:22.5726, Longitude:88.3639, Portfolio:'Supermarket chain' },
      { Vendor:'Coastal Vendors', Type:'Services', Region:'South', Revenue:60000, Latitude:9.9312, Longitude:76.2673, Portfolio:'Local services' }
    ];
    postLoad();
  }

  // ---------- Helpers ----------
  function postLoad(){ detectMeta(); buildFilters(); resetAllFilters(); applyFilters(); exportCsv.disabled=false; exportXlsx.disabled=false; }

  // ---------- Helpers for upload UI (not shown) ----------
  // Debounce for apply filters already implemented

  </script>
</body>
</html>
